---
phase: 03-drive-session-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - metro.config.js
  - babel.config.js
  - src/db/schema/drives.ts
  - src/db/schema/events.ts
  - src/db/schema/breadcrumbs.ts
  - src/db/schema/index.ts
  - src/db/client.ts
  - src/db/migrations.ts
  - drizzle.config.ts
autonomous: true

must_haves:
  truths:
    - "Database tables exist for drives, events, and breadcrumbs"
    - "Drizzle ORM can connect to SQLite and run queries"
    - "App loads with database initialized (no crash)"
  artifacts:
    - path: "src/db/schema/drives.ts"
      provides: "drives table schema"
      contains: "sqliteTable"
    - path: "src/db/schema/events.ts"
      provides: "events table schema"
      contains: "sqliteTable"
    - path: "src/db/schema/breadcrumbs.ts"
      provides: "breadcrumbs table schema"
      contains: "sqliteTable"
    - path: "src/db/client.ts"
      provides: "Drizzle database client"
      exports: ["db", "initDatabase"]
  key_links:
    - from: "src/db/client.ts"
      to: "src/db/schema/index.ts"
      via: "schema import for typed queries"
      pattern: "import.*schema"
    - from: "metro.config.js"
      to: ".sql migration files"
      via: "sourceExts includes sql"
      pattern: "sourceExts.*sql"
---

<objective>
Set up SQLite database with Drizzle ORM for persisting drive sessions, events, and GPS breadcrumbs.

Purpose: Phase 3 requires local persistence that survives app restarts. This plan establishes the data layer foundation using expo-sqlite and drizzle-orm as identified in 03-RESEARCH.md.

Output: Database schema files, Drizzle client, and configuration ready for data operations.
</objective>

<execution_context>
@/Users/papanash/.claude/get-shit-done/workflows/execute-plan.md
@/Users/papanash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-drive-session-management/03-CONTEXT.md
@.planning/phases/03-drive-session-management/03-RESEARCH.md
@src/drive/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install packages and configure bundler</name>
  <files>package.json, metro.config.js, babel.config.js, drizzle.config.ts</files>
  <action>
Install required packages:
```bash
npx expo install expo-sqlite
npm install drizzle-orm
npm install -D drizzle-kit babel-plugin-inline-import
```

Create or update metro.config.js to include .sql extension:
```javascript
const { getDefaultConfig } = require('expo/metro-config');
const config = getDefaultConfig(__dirname);
config.resolver.sourceExts.push('sql');
module.exports = config;
```

Update babel.config.js to add inline-import plugin for .sql files:
```javascript
module.exports = function(api) {
  api.cache(true);
  return {
    presets: ['babel-preset-expo'],
    plugins: [
      ['inline-import', { extensions: ['.sql'] }]
    ]
  };
};
```

Create drizzle.config.ts for migration generation:
```typescript
import type { Config } from 'drizzle-kit';

export default {
  schema: './src/db/schema/index.ts',
  out: './drizzle',
  dialect: 'sqlite',
} satisfies Config;
```

IMPORTANT per 03-RESEARCH.md Pitfall 1: Metro must be configured for .sql or migrations will crash.
  </action>
  <verify>Run `npm ls expo-sqlite drizzle-orm` shows both installed. Check metro.config.js has 'sql' in sourceExts.</verify>
  <done>All packages installed, bundler configured to handle .sql migration files.</done>
</task>

<task type="auto">
  <name>Task 2: Create database schema</name>
  <files>src/db/schema/drives.ts, src/db/schema/events.ts, src/db/schema/breadcrumbs.ts, src/db/schema/index.ts</files>
  <action>
Create src/db/schema/drives.ts:
```typescript
import { sqliteTable, text, integer, real } from 'drizzle-orm/sqlite-core';
import { relations } from 'drizzle-orm';

export const drives = sqliteTable('drives', {
  id: text('id').primaryKey(), // UUID
  startTime: integer('start_time', { mode: 'timestamp_ms' }).notNull(),
  endTime: integer('end_time', { mode: 'timestamp_ms' }),
  durationMs: integer('duration_ms'),
  distanceMeters: real('distance_meters'),
  score: integer('score'), // 0-100, null until drive ends
  spillCount: integer('spill_count').default(0),
  potholeCount: integer('pothole_count').default(0),
  difficulty: text('difficulty').notNull(), // 'easy' | 'experienced' | 'master'
  manualStart: integer('manual_start', { mode: 'boolean' }).default(false),
  manualEnd: integer('manual_end', { mode: 'boolean' }).default(false),
  createdAt: integer('created_at', { mode: 'timestamp_ms' }).notNull().$defaultFn(() => Date.now()),
});

export const drivesRelations = relations(drives, ({ many }) => ({
  events: many(events),
  breadcrumbs: many(breadcrumbs),
}));
```

Create src/db/schema/events.ts:
```typescript
import { sqliteTable, text, integer, real } from 'drizzle-orm/sqlite-core';
import { relations } from 'drizzle-orm';
import { drives } from './drives';

// Event types: 'spill', 'pothole', 'drive_start', 'drive_end', 'gps_lost', 'gps_resumed'
export const events = sqliteTable('events', {
  id: text('id').primaryKey(), // UUID
  driveId: text('drive_id').notNull().references(() => drives.id, { onDelete: 'cascade' }),
  type: text('type').notNull(), // DriveEventType
  timestamp: integer('timestamp', { mode: 'timestamp_ms' }).notNull(),
  latitude: real('latitude'),
  longitude: real('longitude'),
  severity: real('severity'), // how far over threshold (0-1 for spills)
  forgiven: integer('forgiven', { mode: 'boolean' }).default(false), // for potholes on easy/experienced
});

export const eventsRelations = relations(events, ({ one }) => ({
  drive: one(drives, {
    fields: [events.driveId],
    references: [drives.id],
  }),
}));
```

Create src/db/schema/breadcrumbs.ts:
```typescript
import { sqliteTable, text, integer, real, index } from 'drizzle-orm/sqlite-core';
import { relations } from 'drizzle-orm';
import { drives } from './drives';

export const breadcrumbs = sqliteTable('breadcrumbs', {
  id: text('id').primaryKey(), // UUID
  driveId: text('drive_id').notNull().references(() => drives.id, { onDelete: 'cascade' }),
  timestamp: integer('timestamp', { mode: 'timestamp_ms' }).notNull(),
  latitude: real('latitude').notNull(),
  longitude: real('longitude').notNull(),
  speed: real('speed'), // m/s, nullable if GPS didn't provide
}, (table) => [
  index('breadcrumbs_drive_id_idx').on(table.driveId),
]);

export const breadcrumbsRelations = relations(breadcrumbs, ({ one }) => ({
  drive: one(drives, {
    fields: [breadcrumbs.driveId],
    references: [drives.id],
  }),
}));
```

Create src/db/schema/index.ts:
```typescript
export * from './drives';
export * from './events';
export * from './breadcrumbs';
```

Per 03-RESEARCH.md Pitfall 2: Always export relations alongside tables for relational queries to work.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit src/db/schema/index.ts` (or run full type check)</verify>
  <done>Three tables defined with proper relations: drives (parent), events (child), breadcrumbs (child). Indexes on driveId for efficient queries.</done>
</task>

<task type="auto">
  <name>Task 3: Create database client and generate migrations</name>
  <files>src/db/client.ts, src/db/migrations.ts, drizzle/*.sql</files>
  <action>
Generate initial migration:
```bash
npx drizzle-kit generate
```
This creates drizzle/0000_*.sql migration file.

Create src/db/migrations.ts to import generated migrations:
```typescript
// Import all migrations - bundled via babel-plugin-inline-import
import migration0000 from '../../drizzle/0000_*.sql';

// Export migrations in order for drizzle to apply
export default {
  journal: {
    entries: [
      { idx: 0, when: Date.now(), tag: '0000_initial', breakpoints: true },
    ],
  },
  migrations: {
    '0000_initial': migration0000,
  },
};
```

NOTE: The actual filename will be generated by drizzle-kit. Update the import to match the exact filename (e.g., 0000_initial_schema.sql).

Create src/db/client.ts:
```typescript
import { drizzle } from 'drizzle-orm/expo-sqlite';
import { openDatabaseSync } from 'expo-sqlite';
import { useMigrations } from 'drizzle-orm/expo-sqlite/migrator';
import * as schema from './schema';
import migrations from './migrations';

const DATABASE_NAME = 'watercup.db';

// Open database with change listener for live queries (per 03-RESEARCH.md Pitfall 3)
const expoDb = openDatabaseSync(DATABASE_NAME, { enableChangeListener: true });

// Create Drizzle client with full schema for typed queries
export const db = drizzle(expoDb, { schema });

/**
 * Hook to run migrations on app start
 * Use in App.tsx wrapped in Suspense
 *
 * Usage:
 * ```tsx
 * function App() {
 *   const { success, error } = useDatabaseMigrations();
 *   if (error) return <Text>Migration error: {error.message}</Text>;
 *   if (!success) return <Text>Running migrations...</Text>;
 *   return <MainApp />;
 * }
 * ```
 */
export function useDatabaseMigrations() {
  return useMigrations(db, migrations);
}

/**
 * Generate a UUID for new records
 * Uses crypto.randomUUID if available, falls back to timestamp-based
 */
export function generateId(): string {
  if (typeof crypto !== 'undefined' && crypto.randomUUID) {
    return crypto.randomUUID();
  }
  // Fallback for environments without crypto.randomUUID
  return `${Date.now()}-${Math.random().toString(36).substring(2, 11)}`;
}
```

IMPORTANT: Per 03-RESEARCH.md Pitfall 5, migrations must run before any queries. The useDatabaseMigrations hook handles this with a loading state.
  </action>
  <verify>
1. Check drizzle/ folder has migration SQL file: `ls drizzle/*.sql`
2. Run `npx expo start` and check app doesn't crash on load
3. Check SQLite file is created (visible in device storage or simulator)
  </verify>
  <done>Drizzle client initialized with expo-sqlite, migrations run on app start, database ready for queries.</done>
</task>

</tasks>

<verification>
1. Run `npm ls expo-sqlite drizzle-orm drizzle-kit` - all packages present
2. Run `npx tsc --noEmit` - no TypeScript errors in schema files
3. Run `npx drizzle-kit generate` completes without error
4. App starts without database-related crashes
5. Database file exists after app launch
</verification>

<success_criteria>
- expo-sqlite and drizzle-orm installed and configured
- Three tables defined: drives, events, breadcrumbs
- Relations and indexes properly configured
- Migrations generated and apply on app start
- Database client exports db instance and useDatabaseMigrations hook
- App loads without crashing (database initialized)
</success_criteria>

<output>
After completion, create `.planning/phases/03-drive-session-management/03-01-SUMMARY.md`
</output>
