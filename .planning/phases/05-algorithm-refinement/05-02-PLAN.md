---
phase: 05-algorithm-refinement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/audio/AmbientAudioController.ts
  - src/audio/types.ts
  - src/audio/AudioEngine.ts
  - assets/audio/ambient-tension.m4a
  - assets/audio/spill-dramatic.m4a
  - assets/audio/pothole-bump.m4a
autonomous: true

must_haves:
  truths:
    - "Ambient sound loops continuously with volume controllable in real-time"
    - "Volume interpolates smoothly to avoid audio clicks"
    - "Ambient can be silenced instantly on spill and rebuilt gradually"
    - "New sound types are registered and playable"
  artifacts:
    - path: "src/audio/AmbientAudioController.ts"
      provides: "Reactive ambient sound management for Master mode"
      exports: ["AmbientAudioController"]
    - path: "src/audio/types.ts"
      provides: "Extended sound name types"
      contains: "spill-dramatic"
    - path: "src/audio/AudioEngine.ts"
      provides: "Support for new sound assets"
      contains: "pothole-bump"
  key_links:
    - from: "src/audio/AmbientAudioController.ts"
      to: "expo-av"
      via: "Audio.Sound with setVolumeAsync"
      pattern: "setVolumeAsync"
---

<objective>
Create the Master mode ambient audio system that provides reactive soundscape intensifying as jerk approaches threshold.

Purpose: Master mode should feel immersive and tense - the ambient soundscape creates "walking on eggshells" tension that makes spills feel consequential.

Output: AmbientAudioController class and new audio assets registered in AudioEngine for difficulty-specific audio behavior.
</objective>

<execution_context>
@/Users/papanash/.claude/get-shit-done/workflows/execute-plan.md
@/Users/papanash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-algorithm-refinement/05-CONTEXT.md
@.planning/phases/05-algorithm-refinement/05-RESEARCH.md

@src/audio/AudioEngine.ts
@src/audio/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update audio types and create placeholder audio files</name>
  <files>
    src/audio/types.ts
    assets/audio/ambient-tension.m4a
    assets/audio/spill-dramatic.m4a
    assets/audio/pothole-bump.m4a
  </files>
  <action>
1. Update src/audio/types.ts:
   - Add new sound names to SoundName type:
     - 'spill-dramatic' (Master mode heavy splash)
     - 'pothole-bump' (distinct road impact sound)
     - 'ambient-tension' (looping ambient for Master mode)
   - Update SOUND_NAMES array to include new sounds
   - Add AMBIENT_SOUNDS array containing only 'ambient-tension' (for special handling)

2. Create placeholder audio files:
   Since we cannot generate actual audio, create placeholder .m4a files using ffmpeg to generate:
   - ambient-tension.m4a: 30-second sine wave tone at 80Hz (low drone)
   - spill-dramatic.m4a: Copy of spill.m4a as placeholder
   - pothole-bump.m4a: Short 100ms noise burst

   Commands to run:
   ```bash
   # Generate 30-second low drone for ambient
   ffmpeg -f lavfi -i "sine=frequency=80:duration=30" -c:a aac assets/audio/ambient-tension.m4a

   # Copy spill as placeholder for dramatic version
   cp assets/audio/spill.m4a assets/audio/spill-dramatic.m4a

   # Generate short thump for pothole
   ffmpeg -f lavfi -i "sine=frequency=60:duration=0.1" -c:a aac assets/audio/pothole-bump.m4a
   ```

   If ffmpeg is not available, create empty placeholder files and note in SUMMARY that real audio assets are needed.
  </action>
  <verify>
Files exist: `ls -la assets/audio/`
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
New sound types defined. Placeholder audio files exist (may be temporary until real assets provided).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AudioEngine with new sound assets</name>
  <files>src/audio/AudioEngine.ts</files>
  <action>
Update AudioEngine to register the new sound assets:

1. Add new entries to SOUND_ASSETS record:
   - 'spill-dramatic': require('../../assets/audio/spill-dramatic.m4a')
   - 'pothole-bump': require('../../assets/audio/pothole-bump.m4a')

   Note: Do NOT add 'ambient-tension' to SOUND_ASSETS - it will be managed separately by AmbientAudioController with different loading pattern (looping, volume control).

2. The new sounds will be pre-loaded in initialize() automatically because they're in SOUND_NAMES array.

3. No changes to play() method needed - it handles any SoundName.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
App starts: `npx expo start`
  </verify>
  <done>
AudioEngine loads spill-dramatic and pothole-bump sounds on initialization.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create AmbientAudioController class</name>
  <files>src/audio/AmbientAudioController.ts</files>
  <action>
Create AmbientAudioController for Master mode reactive ambient:

1. Import Audio from 'expo-av'

2. Define constants:
   - INTERPOLATION_INTERVAL_MS = 33 (30fps for smooth fades)
   - VOLUME_RAMP_SPEED = 0.03 (per frame, ~1 second to full change)
   - MIN_VOLUME = 0.15 (calm baseline - audible but unobtrusive)
   - MAX_VOLUME = 0.7 (tense maximum - leave headroom for spill sound)
   - REBUILD_DELAY_MS = 2500 (silence duration after spill, matches cooldown)

3. Private state:
   - ambientSound: Audio.Sound | null
   - isPlaying: boolean
   - targetVolume: number
   - currentVolume: number
   - interpolationInterval: ReturnType<typeof setInterval> | null
   - rebuildTimeout: ReturnType<typeof setTimeout> | null
   - isInitialized: boolean

4. Implement methods:

   async initialize(): Promise<void>
   - Load ambient-tension.m4a with Audio.Sound.createAsync
   - Set isLooping: true, volume: 0, shouldPlay: false
   - Set isInitialized = true

   async start(): Promise<void>
   - Guard: if not initialized or already playing, return
   - Set volume to MIN_VOLUME, play sound
   - Start interpolation interval that calls interpolateVolume()
   - Set isPlaying = true

   setRiskLevel(risk: number): void
   - Map risk (0-1) to volume:
     - risk 0 -> MIN_VOLUME
     - risk >= 0.9 -> MAX_VOLUME
     - Linear interpolation between
   - Set targetVolume (interpolation will handle the transition)

   async onSpill(): Promise<void>
   - Instant silence: setVolumeAsync(0), currentVolume = 0
   - targetVolume = 0
   - Schedule rebuildFromSilence after REBUILD_DELAY_MS

   private rebuildFromSilence(): void
   - Set targetVolume = MIN_VOLUME
   - Interpolation will gradually restore ambient

   private async interpolateVolume(): Promise<void>
   - Calculate diff between target and current
   - If |diff| < 0.01, skip (close enough)
   - Step toward target by min(|diff|, VOLUME_RAMP_SPEED)
   - Call setVolumeAsync(currentVolume)
   - Catch and ignore errors (sound might be unloaded)

   async stop(): Promise<void>
   - Clear interpolation interval
   - Clear rebuild timeout
   - Stop sound playback
   - Set isPlaying = false

   async cleanup(): Promise<void>
   - Call stop()
   - Unload sound
   - Set ambientSound = null, isInitialized = false

   Getters:
   - get isActive(): boolean - returns isPlaying

5. Export singleton pattern OR class (recommend class - instantiation controlled by caller based on difficulty).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
AmbientAudioController class exists with volume interpolation and spill silence/rebuild behavior. Ready to be wired to useAudioFeedback in Plan 03.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. New audio types include 'spill-dramatic', 'pothole-bump', 'ambient-tension'
3. AmbientAudioController exists at src/audio/AmbientAudioController.ts
4. Audio assets exist at assets/audio/ (even if placeholders)
5. App starts without crashes: `npx expo start`
</verification>

<success_criteria>
- Master mode can use AmbientAudioController for reactive soundscape
- Volume changes interpolate smoothly (no clicking)
- Spill triggers instant silence followed by gradual rebuild
- New sounds (spill-dramatic, pothole-bump) are loadable
- Ambient loops without manual restart
</success_criteria>

<output>
After completion, create `.planning/phases/05-algorithm-refinement/05-02-SUMMARY.md`
</output>
