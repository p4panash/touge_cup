---
phase: 04-ui-user-experience
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/(tabs)/index.tsx
  - app/drive/active.tsx
  - src/components/home/StartButton.tsx
  - src/components/home/DifficultySelector.tsx
  - src/components/home/RecentDrive.tsx
  - src/components/drive/WaterCup.tsx
  - src/components/drive/SpillCounter.tsx
  - src/components/drive/StreakTimer.tsx
  - src/components/drive/StopButton.tsx
  - src/hooks/useConfigurableKeepAwake.ts
autonomous: true

must_haves:
  truths:
    - "User sees hero start button on home screen"
    - "User can select difficulty via segmented control"
    - "User sees most recent completed drive on home"
    - "Active drive shows water cup that responds to motion"
    - "Active drive shows spill count and streak timer"
    - "User can stop drive with visible button"
  artifacts:
    - path: "app/(tabs)/index.tsx"
      provides: "Home screen implementation"
      min_lines: 50
    - path: "app/drive/active.tsx"
      provides: "Active drive screen"
      min_lines: 80
    - path: "src/components/drive/WaterCup.tsx"
      provides: "Animated water cup visualization"
      contains: "useAnimatedSensor"
    - path: "src/components/home/DifficultySelector.tsx"
      provides: "Segmented control for difficulty"
      contains: "SegmentedControl"
  key_links:
    - from: "app/(tabs)/index.tsx"
      to: "useDriveDetection"
      via: "startManual call on button press"
      pattern: "startManual"
    - from: "src/components/drive/WaterCup.tsx"
      to: "useAnimatedSensor"
      via: "accelerometer data"
      pattern: "SensorType.ACCELEROMETER"
    - from: "app/drive/active.tsx"
      to: "useDriveStore"
      via: "spill count subscription"
      pattern: "useDriveStore"
---

<objective>
Build the Home screen and Active drive screen - the core user journey.

Purpose: These two screens are the primary interaction path. User starts a drive from Home, sees feedback during Active drive.
Output: Fully functional home screen with start button, difficulty selector, recent drive. Active drive screen with animated water cup, spill counter, streak timer, and stop button.
</objective>

<execution_context>
@/Users/papanash/.claude/get-shit-done/workflows/execute-plan.md
@/Users/papanash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-ui-user-experience/04-CONTEXT.md
@.planning/phases/04-ui-user-experience/04-RESEARCH.md
@.planning/phases/04-ui-user-experience/04-01-SUMMARY.md
@src/hooks/useDriveDetection.ts
@src/hooks/useDriveHistory.ts
@src/stores/useSensorStore.ts
@src/stores/useDriveStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build Home screen components</name>
  <files>
    src/components/home/StartButton.tsx
    src/components/home/DifficultySelector.tsx
    src/components/home/RecentDrive.tsx
    app/(tabs)/index.tsx
  </files>
  <action>
Create src/components/home/StartButton.tsx:
- Large, centered hero button (primary action)
- Uses useTheme for colors
- onPress prop for navigation/start logic
- Style: Large circular or pill shape, prominent primary color, bold text "START DRIVE"
- Disabled state when drive already active

Create src/components/home/DifficultySelector.tsx:
- Use @react-native-segmented-control/segmented-control
- Three segments: Easy | Experienced | Master
- Connect to useSensorStore.difficulty and setDifficulty
- Use useTheme for appearance (dark/light)
- Per RESEARCH.md pattern for segmented control

Create src/components/home/RecentDrive.tsx:
- Shows SINGLE most recent completed drive (per CONTEXT.md decision)
- Display: date/time, score, spill count, duration
- Tappable to navigate to drive summary
- Empty state if no drives yet
- Uses useTheme for card styling

Update app/(tabs)/index.tsx (Home screen):
- Layout: SafeAreaView with centered content
- Top: App title "Water Cup Coach"
- Middle: StartButton (hero, dominant)
- Below button: DifficultySelector
- Bottom: RecentDrive card (or empty state)
- Use useDriveDetection hook for startManual
- Use router.push('/drive/active') after starting drive
- Use useDriveHistory(1) to get most recent drive

Navigation flow:
1. User taps Start Drive button
2. Call startManual() from useDriveDetection
3. Navigate to /drive/active screen
  </action>
  <verify>
Run app and verify:
1. Home screen shows with Start Drive button centered
2. Difficulty selector shows Easy/Experienced/Master, selection persists
3. If completed drives exist, most recent shows at bottom
4. Tapping Start Drive initiates drive (check console/store)
5. TypeScript: `npx tsc --noEmit`
  </verify>
  <done>
Home screen displays hero start button, difficulty segmented control, and most recent drive card.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Active drive screen with water cup animation</name>
  <files>
    src/components/drive/WaterCup.tsx
    src/components/drive/SpillCounter.tsx
    src/components/drive/StreakTimer.tsx
    src/components/drive/StopButton.tsx
    src/hooks/useConfigurableKeepAwake.ts
    app/drive/active.tsx
  </files>
  <action>
Create src/hooks/useConfigurableKeepAwake.ts:
- Per RESEARCH.md code example
- Takes enabled boolean and optional tag
- Uses activateKeepAwakeAsync/deactivateKeepAwake from expo-keep-awake
- Cleans up on unmount
- Will be connected to settings store later (default: enabled during drive)

Create src/components/drive/WaterCup.tsx:
- Per RESEARCH.md Pattern 2: Accelerometer-Driven Water Animation
- Use useAnimatedSensor(SensorType.ACCELEROMETER, { interval: 16 }) for 60fps
- Props: fillLevel (0-1, drops on spills)
- Cup container with water inside
- Water surface tilts based on x/y acceleration using useAnimatedStyle
- interpolate acceleration values to rotation degrees (clamp -15 to 15)
- Visual: Cup outline, water fill with animated tilt
- Style: Dark blue water on light theme, cyan water on dark theme

Create src/components/drive/SpillCounter.tsx:
- Shows current spill count
- Large number display
- Label "Spills"
- Uses theme colors

Create src/components/drive/StreakTimer.tsx:
- Shows time since last spill (current streak)
- Format: MM:SS or "Perfect!" if no spills
- Updates every second while driving
- Resets on spill

Create src/components/drive/StopButton.tsx:
- Visible button to end drive manually (per CONTEXT.md decision)
- Style: Danger color, clear "STOP" text
- onPress prop for stop logic

Update app/drive/active.tsx:
- Layout: Full screen, minimal UI
- Center: WaterCup (dominant visual)
- Top row: SpillCounter on left, StreakTimer on right
- Bottom: StopButton
- Connect to stores:
  - useSensorStore for risk (to calculate fill level - 1 minus cumulative spill impact)
  - useDriveStore for spill tracking (need to add spill counter to store or derive from events)
  - useDriveDetection for stopManual
- Use useConfigurableKeepAwake(true) to keep screen on during drive
- On stop: navigate back to home or to summary

Fill level calculation:
- Start at 1.0 (full cup)
- Each spill reduces by 0.1 (or severity-based amount)
- Minimum 0.1 (never completely empty for visual appeal)
- Track locally in component state, reset on drive start

Streak timer:
- Track driveStartTime or lastSpillTime
- Calculate seconds since last spill
- Update via setInterval every 1000ms
  </action>
  <verify>
Run app and verify:
1. Start drive from home, navigates to active screen
2. Water cup renders and tilts when phone is moved
3. Spill counter shows 0 initially
4. Streak timer counts up
5. Stop button visible, tapping ends drive
6. Screen stays awake during drive
7. TypeScript: `npx tsc --noEmit`
  </verify>
  <done>
Active drive screen shows animated water cup responding to accelerometer, spill count, streak timer, and stop button. Screen stays awake during drive.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Full flow: Home -> tap Start -> Active drive screen shows
2. Water cup animates smoothly with phone movement
3. Spill count increments when spill occurs (may need actual drive to test)
4. Streak timer counts up from drive start
5. Stop button ends drive and returns to home
6. Difficulty selection on home persists across app restarts (stored in Zustand)
7. Recent drive shows if available, navigates to summary on tap
</verification>

<success_criteria>
- Home screen: hero start button, difficulty selector, recent drive display
- Active screen: water cup with real-time slosh animation
- Active screen: spill counter and streak timer visible
- Active screen: stop button clearly visible and functional
- Keep-awake active during drive
- Navigation flow works: Home -> Active -> Home (on stop)
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-user-experience/04-02-SUMMARY.md`
</output>
