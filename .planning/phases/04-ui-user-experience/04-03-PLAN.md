---
phase: 04-ui-user-experience
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/drive/summary/[id].tsx
  - app/(tabs)/history/[id].tsx
  - src/components/summary/RouteMap.tsx
  - src/components/summary/SpillMarker.tsx
  - src/components/summary/StatsBreakdown.tsx
autonomous: true
user_setup:
  - service: google-maps-android
    why: "Map display on Android requires Google Maps API key"
    env_vars: []
    dashboard_config:
      - task: "Create Google Cloud project and enable Maps SDK for Android"
        location: "Google Cloud Console -> APIs & Services -> Enable APIs"
      - task: "Create API key and add to app.json android.config.googleMaps.apiKey"
        location: "Google Cloud Console -> APIs & Services -> Credentials"

must_haves:
  truths:
    - "User sees route on map with color-coded polyline"
    - "User sees water drop markers at spill locations"
    - "User can tap marker to see spill details"
    - "User sees full stats breakdown (score, duration, distance, spills)"
  artifacts:
    - path: "app/drive/summary/[id].tsx"
      provides: "Drive summary screen"
      min_lines: 100
    - path: "src/components/summary/RouteMap.tsx"
      provides: "Map with polyline and markers"
      contains: "MapView"
    - path: "src/components/summary/SpillMarker.tsx"
      provides: "Tappable spill marker with callout"
      contains: "Callout"
    - path: "src/components/summary/StatsBreakdown.tsx"
      provides: "Full statistics display"
      min_lines: 40
  key_links:
    - from: "app/drive/summary/[id].tsx"
      to: "useDriveDetail"
      via: "fetch drive with events and breadcrumbs"
      pattern: "useDriveDetail"
    - from: "src/components/summary/RouteMap.tsx"
      to: "Polyline strokeColors"
      via: "color array for route"
      pattern: "strokeColors"
---

<objective>
Build the Drive summary screen with map visualization and statistics.

Purpose: Post-drive analysis showing route, spill locations, and performance metrics. Key for user to understand their driving patterns.
Output: Summary screen with color-coded route polyline, tappable spill markers, and comprehensive stats breakdown.
</objective>

<execution_context>
@/Users/papanash/.claude/get-shit-done/workflows/execute-plan.md
@/Users/papanash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-ui-user-experience/04-CONTEXT.md
@.planning/phases/04-ui-user-experience/04-RESEARCH.md
@.planning/phases/04-ui-user-experience/04-01-SUMMARY.md
@src/hooks/useDriveHistory.ts
@src/db/schema/drives.ts
@src/db/schema/events.ts
@src/db/schema/breadcrumbs.ts
@src/db/queries/drives.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build RouteMap and SpillMarker components</name>
  <files>
    src/components/summary/RouteMap.tsx
    src/components/summary/SpillMarker.tsx
  </files>
  <action>
Create src/components/summary/RouteMap.tsx:
- Props: breadcrumbs array, events array (spills only)
- Uses react-native-maps MapView
- Calculate region from breadcrumbs (find min/max lat/lng, add padding)
- Render Polyline with:
  - coordinates from breadcrumbs (latitude, longitude)
  - strokeColors array matching coordinates length (per RESEARCH.md Pitfall 2)
  - strokeWidth: 4

Color-coding logic (per CONTEXT.md: green=good, red=rough):
- For each breadcrumb, check proximity to spill events
- If spill within 50m and 10 seconds: red (#ff4444)
- If spill within 100m and 30 seconds: orange (#ffaa00)
- Otherwise: green (#00ff00)
- Helper function: haversineDistance(lat1, lon1, lat2, lon2) for distance calc

Map region calculation:
```typescript
function calculateRegion(coords: {latitude: number, longitude: number}[]) {
  const lats = coords.map(c => c.latitude);
  const lngs = coords.map(c => c.longitude);
  const minLat = Math.min(...lats);
  const maxLat = Math.max(...lats);
  const minLng = Math.min(...lngs);
  const maxLng = Math.max(...lngs);

  return {
    latitude: (minLat + maxLat) / 2,
    longitude: (minLng + maxLng) / 2,
    latitudeDelta: (maxLat - minLat) * 1.2 || 0.01,
    longitudeDelta: (maxLng - minLng) * 1.2 || 0.01,
  };
}
```

Render SpillMarker for each spill event.

Create src/components/summary/SpillMarker.tsx:
- Per RESEARCH.md code example for Spill Marker with Callout
- Props: event (DriveEvent with type='spill')
- Custom marker: water drop icon (can use emoji or simple View with styling)
- Callout (tooltip) showing:
  - Severity label (Minor/Moderate/Major based on severity value)
  - Timestamp (formatted time)
- anchor prop for proper positioning
- Use Marker from react-native-maps with custom children for icon

Severity mapping:
- severity < 0.5: "Minor Spill" (yellow icon)
- severity < 0.7: "Moderate Spill" (orange icon)
- severity >= 0.7: "Major Spill" (red icon)

Note on iOS vs Android: react-native-maps uses Apple Maps on iOS (no API key needed) and Google Maps on Android (needs API key). For initial development without Android API key, maps will show on iOS. Android will need user_setup to add Google Maps API key.
  </action>
  <verify>
TypeScript compilation: `npx tsc --noEmit`
Components exist and export correctly.
Run on iOS to verify map renders (Android may need API key).
  </verify>
  <done>
RouteMap component renders polyline with color coding based on spill proximity. SpillMarker shows water drop icon with tappable callout popup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build StatsBreakdown and wire up Summary screen</name>
  <files>
    src/components/summary/StatsBreakdown.tsx
    app/drive/summary/[id].tsx
    app/(tabs)/history/[id].tsx
  </files>
  <action>
Create src/components/summary/StatsBreakdown.tsx:
- Props: drive (full drive object with score, duration, distance, spills, etc.)
- Grid layout showing all stats per CONTEXT.md:
  - Score (large, prominent): 0-100 with color coding (green >80, yellow 50-80, red <50)
  - Spill count: number with label
  - Duration: formatted as HH:MM:SS or MM:SS
  - Distance: formatted as km with one decimal
  - Average speed: calculated from distance/duration, km/h
  - Difficulty: badge showing Easy/Experienced/Master
  - Perfect drive bonus: Show if spillCount === 0

Formatting helpers:
```typescript
function formatDuration(ms: number): string {
  const totalSeconds = Math.floor(ms / 1000);
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;
  if (hours > 0) {
    return `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }
  return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

function formatDistance(meters: number): string {
  return (meters / 1000).toFixed(1) + ' km';
}
```

Use useTheme for colors. Card-style layout with clear hierarchy.

Update app/drive/summary/[id].tsx:
- Get drive ID from route params: useLocalSearchParams()
- Use useDriveDetail(id) hook to fetch drive with events and breadcrumbs
- Loading state while fetching
- Error state if drive not found
- Layout:
  - Top: Title "Drive Summary" with back button (auto from Stack)
  - Upper half: RouteMap (flex: 1 to fill available space)
  - Lower half: StatsBreakdown in ScrollView
- Filter events to only spills: events.filter(e => e.type === 'spill')
- Handle empty breadcrumbs gracefully (show message instead of empty map)

Update app/(tabs)/history/[id].tsx:
- Can either redirect to /drive/summary/[id] or render same content
- Recommended: Use same component/layout as summary
- Import and reuse the summary screen logic or redirect with router.replace

Note: The drive detail includes events and breadcrumbs via the getDriveById query with relations.
  </action>
  <verify>
Run app and test:
1. Navigate to a completed drive's summary (from recent drive card on home or history)
2. Map renders with route polyline (on iOS, Android needs API key)
3. Polyline has color variations (may all be green if no spills near breadcrumbs)
4. Spill markers appear at spill locations
5. Tapping marker shows callout with severity and time
6. Stats breakdown shows score, spills, duration, distance
7. TypeScript: `npx tsc --noEmit`
  </verify>
  <done>
Drive summary screen shows map with color-coded route, tappable spill markers with callouts, and full statistics breakdown including score, duration, distance, and spills.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Navigate to drive summary from home (recent drive) or history
2. Map displays with route polyline
3. Polyline colors vary based on spill proximity (green/orange/red)
4. Water drop markers at spill locations
5. Tap marker -> callout shows severity and timestamp
6. Stats section shows all metrics clearly
7. Works on iOS (Android will need Google Maps API key setup)
</verification>

<success_criteria>
- Drive summary accessible via /drive/summary/[id] route
- Map shows full route with strokeColors polyline
- Spill markers visible and tappable
- Callout popup works on marker tap
- Stats breakdown shows: score, spill count, duration, distance, avg speed, difficulty
- Loading and error states handled
- iOS works out of box, Android documents API key requirement
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-user-experience/04-03-SUMMARY.md`
</output>
