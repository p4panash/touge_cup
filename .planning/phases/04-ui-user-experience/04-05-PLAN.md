---
phase: 04-ui-user-experience
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - app/(tabs)/_layout.tsx
  - app/(tabs)/index.tsx
  - app/drive/active.tsx
  - app/drive/_layout.tsx
  - app/drive/summary/[id].tsx
  - src/stores/useSettingsStore.ts
  - src/stores/useSensorStore.ts
  - src/hooks/useSensorPipeline.ts
  - src/hooks/useDriveDetection.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Tab bar uses proper icons (lucide-react-native), not emoji"
    - "Difficulty selector appears directly below Start button (no expanding flex)"
    - "Active drive stats row respects safe area insets (no status bar overlap)"
    - "Drive Summary screen has a back button that navigates to home"
    - "Stopping a drive navigates to Drive Summary screen (not home)"
    - "Keep Awake toggle persists across app restarts"
    - "Difficulty setting syncs between Settings and Home screen across app lifecycle"
  artifacts:
    - path: "app/(tabs)/_layout.tsx"
      provides: "Lucide icons for tab bar"
      contains: "lucide-react-native"
    - path: "app/(tabs)/index.tsx"
      provides: "Cohesive button+difficulty layout"
    - path: "app/drive/active.tsx"
      provides: "Safe area aware stats row"
      contains: "useSafeAreaInsets"
    - path: "src/stores/useSettingsStore.ts"
      provides: "Persisted settings"
      contains: "persist"
    - path: "src/stores/useSensorStore.ts"
      provides: "Persisted difficulty"
      contains: "persist"
  key_links:
    - from: "app/drive/active.tsx"
      to: "/drive/summary/{id}"
      via: "handleStop navigation"
      pattern: "router\\.replace.*summary"
    - from: "src/stores/useSettingsStore.ts"
      to: "AsyncStorage"
      via: "zustand persist middleware"
      pattern: "createJSONStorage"
---

<objective>
Fix 7 UAT-diagnosed gaps from Phase 4 testing

Purpose: Address user-reported issues before moving to Phase 5
Output: All 7 UAT items pass re-testing
</objective>

<execution_context>
@/Users/papanash/.claude/get-shit-done/workflows/execute-plan.md
@/Users/papanash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ui-user-experience/04-UAT.md

# Files to modify
@app/(tabs)/_layout.tsx
@app/(tabs)/index.tsx
@app/drive/active.tsx
@app/drive/_layout.tsx
@app/drive/summary/[id].tsx
@src/stores/useSettingsStore.ts
@src/stores/useSensorStore.ts
@src/hooks/useSensorPipeline.ts
@src/hooks/useDriveDetection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace emoji tab icons with lucide-react-native</name>
  <files>app/(tabs)/_layout.tsx, package.json</files>
  <action>
1. Install lucide-react-native:
   ```
   npx expo install lucide-react-native
   ```

2. Update app/(tabs)/_layout.tsx:
   - Import icons from lucide-react-native: Home, BarChart3, Settings
   - Replace TabIcon component that renders emoji Text with actual icon components
   - Use size={24} and color prop for icons
   - Remove the emoji-based TabIcon function entirely

Tab icon mapping:
- "index" (Home tab): Home icon
- "history" (History tab): BarChart3 icon (or Clock/History if available)
- "settings" (Settings tab): Settings icon
  </action>
  <verify>
   - `npm run lint` passes
   - App builds without errors
   - Tab bar shows SVG icons instead of emoji
  </verify>
  <done>Tab bar displays proper lucide icons for all three tabs</done>
</task>

<task type="auto">
  <name>Task 2: Fix home screen layout - difficulty below start button</name>
  <files>app/(tabs)/index.tsx</files>
  <action>
Fix the home screen layout so difficulty selector appears directly below the Start button as a cohesive unit:

1. Remove `flex: 1` from buttonContainer style (this is what pushes difficulty far below)
2. Group StartButton and DifficultySelector into a single "heroSection" View
3. Keep heroSection centered vertically with `flex: 1` and `justifyContent: 'center'`
4. Add small margin (Spacing.lg or Spacing.xl) between button and selector inside heroSection

Layout should be:
```
[header]
[        heroSection (flex:1, centered)        ]
[   StartButton                                ]
[   DifficultySelector (right below button)    ]
[recentContainer]
```

The button and selector should feel like one unit in the center of the screen.
  </action>
  <verify>
   - Visual check: Difficulty selector is directly below Start button
   - Both button and selector are centered vertically as a unit
   - Recent drive card remains at bottom
  </verify>
  <done>Start button and difficulty selector form cohesive centered unit</done>
</task>

<task type="auto">
  <name>Task 3: Fix active drive status bar overlap with safe area insets</name>
  <files>app/drive/active.tsx</files>
  <action>
The stats row (spill counter + streak timer) overlaps with the device status bar because the screen uses fixed paddingTop without accounting for safe area.

1. Import useSafeAreaInsets from react-native-safe-area-context
2. Get insets at component top: `const insets = useSafeAreaInsets();`
3. Update container style to use dynamic paddingTop:
   ```typescript
   paddingTop: insets.top + Spacing.md
   ```
   This adds the safe area inset PLUS some breathing room.

4. Consider adding paddingBottom based on insets.bottom for the stop button area (though modal presentation may already handle this).

The stats row must never overlap with the status bar on any device (including iPhone notch models).
  </action>
  <verify>
   - On iOS Simulator with notch: stats row appears below status bar
   - Stats are readable without any overlap
  </verify>
  <done>Active drive screen respects safe area insets, no status bar overlap</done>
</task>

<task type="auto">
  <name>Task 4: Add back button to Drive Summary and fix post-drive navigation</name>
  <files>app/drive/active.tsx, app/drive/_layout.tsx, app/drive/summary/[id].tsx, src/hooks/useDriveDetection.ts</files>
  <action>
Two related issues:
A) Drive Summary has no back button
B) Stopping a drive goes to Home instead of Summary

**Part A: Drive Summary back button**

In app/drive/_layout.tsx, update the summary/[id] Stack.Screen options:
```typescript
<Stack.Screen
  name="summary/[id]"
  options={{
    title: 'Drive Summary',
    headerLeft: () => (
      <Pressable onPress={() => router.replace('/')}>
        <Text>Done</Text>  // or use lucide ChevronLeft icon
      </Pressable>
    ),
    // Prevent going back to active drive
    gestureEnabled: false,
  }}
/>
```

Alternative: Just set `headerBackVisible: true` and let expo-router handle it, but ensure the back goes to Home not Active.

Actually simpler approach in app/drive/summary/[id].tsx:
- Use expo-router's Stack.Screen component inline to configure header
- Add a "Done" button that navigates to home

**Part B: Navigate to Summary after stopping**

In app/drive/active.tsx, update handleStop:

1. Before calling stopManual(), get the drive ID:
   ```typescript
   import { DriveRecorder } from '@/services/DriveRecorder';

   const handleStop = useCallback(async () => {
     // Capture drive ID before stopping (stopManual clears it)
     const driveId = DriveRecorder.getCurrentDriveId();

     stopManual();

     // Navigate to summary if we have a drive ID, otherwise home
     if (driveId) {
       router.replace(`/drive/summary/${driveId}`);
     } else {
       router.replace('/');
     }
   }, [stopManual, router]);
   ```

2. The drive ends in DriveRecorder.endDrive() which is called by useDriveDetection.stopManual(), so we need to get the ID before that call.

Note: DriveRecorder already has getCurrentDriveId() method that returns the current drive ID.
  </action>
  <verify>
   - Stop a drive: automatically navigates to Drive Summary screen
   - Drive Summary shows "Done" or back button in header
   - Tapping back/Done goes to Home tab, not back to active drive
  </verify>
  <done>Stopping drive shows summary; summary has navigation back to home</done>
</task>

<task type="auto">
  <name>Task 5: Persist settings and difficulty with Zustand middleware</name>
  <files>src/stores/useSettingsStore.ts, src/stores/useSensorStore.ts, src/hooks/useSensorPipeline.ts</files>
  <action>
Three sub-issues:
A) Keep Awake toggle doesn't persist (resets to true on restart)
B) Difficulty selection doesn't persist (resets to 'easy')
C) useSensorPipeline.stop() calls resetStore() which wipes difficulty

**Part A: Persist useSettingsStore**

```typescript
import { create } from 'zustand';
import { persist, createJSONStorage } from 'zustand/middleware';
import AsyncStorage from '@react-native-async-storage/async-storage';

export const useSettingsStore = create<SettingsStore>()(
  persist(
    (set) => ({
      // ... existing state and actions
    }),
    {
      name: 'settings-storage',
      storage: createJSONStorage(() => AsyncStorage),
    }
  )
);
```

**Part B: Persist difficulty in useSensorStore (partial persist)**

Only persist the difficulty field, not the high-frequency sensor data:

```typescript
import { persist, createJSONStorage } from 'zustand/middleware';
import AsyncStorage from '@react-native-async-storage/async-storage';

export const useSensorStore = create<SensorStore>()(
  persist(
    (set) => ({
      // ... existing state and actions
    }),
    {
      name: 'sensor-storage',
      storage: createJSONStorage(() => AsyncStorage),
      partialize: (state) => ({ difficulty: state.difficulty }),
    }
  )
);
```

**Part C: Fix useSensorPipeline.stop() reset behavior**

In src/hooks/useSensorPipeline.ts, the stop() function calls resetStore() which wipes ALL state including difficulty.

Change reset() to only reset sensor-specific state, not difficulty:

Option 1: Create a new action `resetSensorState()` that resets everything EXCEPT difficulty:
```typescript
resetSensorState: () => {
  set({
    latestData: null,
    isActive: false,
    risk: 0,
    isSpill: false,
    jerkMagnitude: 0,
    isSettling: false,
    // NOTE: difficulty is NOT reset
  });
},
```

Option 2: In useSensorPipeline.stop(), manually reset only the sensor fields:
```typescript
const stop = useCallback(() => {
  // ... existing stop logic

  // Reset only sensor state, preserve difficulty
  useSensorStore.setState({
    latestData: null,
    isActive: false,
    risk: 0,
    isSpill: false,
    jerkMagnitude: 0,
    isSettling: false,
  });
}, []);
```

Use Option 1 (cleaner separation). Add resetSensorState to SensorActions interface.
  </action>
  <verify>
   - Change Keep Awake to OFF in Settings
   - Kill and restart app
   - Check Settings: Keep Awake should still be OFF
   - Change difficulty to Master in Settings
   - Kill and restart app
   - Check Home: difficulty should show Master selected
   - Start and stop a drive
   - Check: difficulty should still be Master (not reset to Easy)
  </verify>
  <done>Settings and difficulty persist across app restarts and drive cycles</done>
</task>

</tasks>

<verification>
After all tasks complete, run through original UAT tests:

1. Tab Navigation - Icons should be proper SVG, not emoji
2. Home Screen Layout - Difficulty directly below Start button
3. Start Drive Flow - No status bar overlap on active screen
4. Drive Summary Map - Has back/Done button
5. History Detail Navigation - Ending drive shows summary
6. Keep Awake Toggle - OFF persists across restart
7. Difficulty Selector in Settings - Syncs with home screen
</verification>

<success_criteria>
- All 7 diagnosed UAT gaps are resolved
- App builds without errors on iOS
- `npm run lint` passes
- Settings persist via AsyncStorage
- Difficulty persists across drives and restarts
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-user-experience/04-05-SUMMARY.md`
</output>
