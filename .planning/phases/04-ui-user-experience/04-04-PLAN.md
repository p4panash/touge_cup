---
phase: 04-ui-user-experience
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - app/(tabs)/history/index.tsx
  - app/(tabs)/settings.tsx
  - src/components/history/DriveListItem.tsx
  - src/components/history/FilterBar.tsx
  - src/components/settings/SettingRow.tsx
  - src/components/settings/SettingToggle.tsx
  - src/stores/useSettingsStore.ts
autonomous: true

must_haves:
  truths:
    - "User sees list of past drives sorted by date"
    - "User can filter drives by difficulty"
    - "User can sort drives by score or date"
    - "User can adjust difficulty setting"
    - "User can toggle keep-screen-awake setting"
  artifacts:
    - path: "app/(tabs)/history/index.tsx"
      provides: "History list screen"
      contains: "FlatList"
    - path: "app/(tabs)/settings.tsx"
      provides: "Settings screen"
      min_lines: 60
    - path: "src/components/history/FilterBar.tsx"
      provides: "Difficulty filter and sort controls"
      min_lines: 30
    - path: "src/stores/useSettingsStore.ts"
      provides: "Persisted settings state"
      exports: ["useSettingsStore"]
  key_links:
    - from: "app/(tabs)/history/index.tsx"
      to: "useDriveHistory"
      via: "fetch drives list"
      pattern: "useDriveHistory"
    - from: "app/(tabs)/settings.tsx"
      to: "useSettingsStore"
      via: "read and update settings"
      pattern: "useSettingsStore"
---

<objective>
Build the History screen with filtering and the Settings screen.

Purpose: History lets users review past performance. Settings provides user customization for difficulty and preferences.
Output: Scrollable history list with filters, settings screen with difficulty selector and keep-awake toggle.
</objective>

<execution_context>
@/Users/papanash/.claude/get-shit-done/workflows/execute-plan.md
@/Users/papanash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-ui-user-experience/04-CONTEXT.md
@.planning/phases/04-ui-user-experience/04-RESEARCH.md
@.planning/phases/04-ui-user-experience/04-01-SUMMARY.md
@src/hooks/useDriveHistory.ts
@src/stores/useSensorStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build History screen with filtering</name>
  <files>
    src/components/history/DriveListItem.tsx
    src/components/history/FilterBar.tsx
    app/(tabs)/history/index.tsx
  </files>
  <action>
Create src/components/history/DriveListItem.tsx:
- Props: drive (DriveListItem type from useDriveHistory)
- Card layout showing:
  - Date/time (formatted nicely: "Today 2:30 PM" or "Feb 3, 2:30 PM")
  - Score (large, color-coded)
  - Spill count with icon/label
  - Duration formatted
  - Difficulty badge (colored: Easy=green, Experienced=yellow, Master=red)
- Fixed height (80px per RESEARCH.md FlatList optimization)
- Pressable: navigates to drive detail on tap
- Use useTheme for styling

Create src/components/history/FilterBar.tsx:
- Props: sortBy, onSortChange, difficultyFilter, onDifficultyChange
- Layout: horizontal row with two controls
- Difficulty filter: Segmented control or dropdown with options: All, Easy, Experienced, Master
- Sort control: Two-option toggle (Date / Score)
- Compact design that doesn't take too much vertical space
- Use useTheme for colors

Update app/(tabs)/history/index.tsx:
- Per RESEARCH.md History List with Filtering code example
- State: sortBy ('date' | 'score'), difficultyFilter ('all' | 'easy' | 'experienced' | 'master')
- Use useDriveHistory(100) to get drives
- useMemo for filteredDrives:
  - Filter by difficulty if not 'all'
  - Sort by date (descending) or score (descending)
- FlatList with:
  - data={filteredDrives}
  - renderItem with useCallback (per RESEARCH.md pitfall 3)
  - keyExtractor with useCallback
  - getItemLayout for fixed 80px height
  - windowSize={5} for memory efficiency
  - maxToRenderPerBatch={10}
  - onRefresh={refresh}
  - refreshing={loading}
- Empty state: "No drives yet. Start your first drive!"
- Loading state handled by refreshing prop
- Navigate to /drive/summary/[id] on item press

Date formatting helper:
```typescript
function formatDriveDate(date: Date): string {
  const now = new Date();
  const today = now.toDateString();
  const yesterday = new Date(now.getTime() - 86400000).toDateString();
  const driveDate = date.toDateString();

  const time = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });

  if (driveDate === today) return `Today ${time}`;
  if (driveDate === yesterday) return `Yesterday ${time}`;
  return date.toLocaleDateString([], { month: 'short', day: 'numeric' }) + ` ${time}`;
}
```
  </action>
  <verify>
Run app and test:
1. History tab shows list of completed drives
2. Pull-to-refresh works
3. Scroll performance is smooth (no jank)
4. Filter by difficulty works (shows only matching drives)
5. Sort by date vs score works
6. Tap drive navigates to summary
7. Empty state shows when no drives
8. TypeScript: `npx tsc --noEmit`
  </verify>
  <done>
History screen displays scrollable list of past drives with filtering by difficulty and sorting by date or score. Each item shows key stats and navigates to summary on tap.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Settings screen with preferences</name>
  <files>
    src/stores/useSettingsStore.ts
    src/components/settings/SettingRow.tsx
    src/components/settings/SettingToggle.tsx
    app/(tabs)/settings.tsx
  </files>
  <action>
Create src/stores/useSettingsStore.ts:
- Zustand store for user preferences
- State:
  - keepScreenAwake: boolean (default: true)
  - audioVolume: number (0-1, default: 1.0) - for future use
- Actions:
  - setKeepScreenAwake(enabled: boolean)
  - setAudioVolume(volume: number)
- Note: Difficulty is already in useSensorStore, don't duplicate

Consider AsyncStorage persistence (optional for this phase):
- Zustand persist middleware could be added
- For now, defaults on app restart are acceptable

Create src/components/settings/SettingRow.tsx:
- Generic row component for settings
- Props: label, description (optional), children (right side content)
- Layout: label on left, children on right
- Consistent spacing and styling

Create src/components/settings/SettingToggle.tsx:
- Props: label, description, value, onValueChange
- Uses SettingRow internally
- Renders Switch component on right side
- Accessible: proper labels for screen readers

Update app/(tabs)/settings.tsx:
- ScrollView layout with sections
- Section 1: Driving
  - Difficulty selector (reuse DifficultySelector component from home, or inline SegmentedControl)
  - Connect to useSensorStore.difficulty and setDifficulty
- Section 2: Display
  - Keep Screen Awake toggle (connect to useSettingsStore)
  - Description: "Prevents screen from sleeping during active drives"
- Section 3: Audio (placeholder for Phase 5)
  - Volume slider (can be placeholder or functional)
- Section 4: About
  - App version
  - "Water Cup Coach v1.0.0"

Section headers with ThemedText variant for section titles.
Use SafeAreaView for proper insets.

Wire up keep-awake:
- Update useConfigurableKeepAwake in active drive to read from useSettingsStore:
```typescript
const keepAwakeEnabled = useSettingsStore(s => s.keepScreenAwake);
useConfigurableKeepAwake(keepAwakeEnabled);
```
  </action>
  <verify>
Run app and test:
1. Settings tab shows all sections
2. Difficulty selector works (changes persist, affects new drives)
3. Keep Screen Awake toggle works
4. Start a drive with toggle OFF - screen can sleep
5. Start a drive with toggle ON - screen stays awake
6. TypeScript: `npx tsc --noEmit`
  </verify>
  <done>
Settings screen allows user to select difficulty, toggle keep-screen-awake, and view app info. Settings affect app behavior (difficulty for new drives, keep-awake during drives).
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. History tab shows all completed drives
2. Filter controls work (difficulty filter, date/score sort)
3. List scrolls smoothly with many items
4. Tap drive -> navigates to summary
5. Settings tab shows all options
6. Difficulty change in settings reflects in new drives
7. Keep-awake toggle affects active drive behavior
8. All screens follow system dark/light theme
</verification>

<success_criteria>
- History list with FlatList, proper virtualization (no scroll jank)
- Filter by difficulty (All/Easy/Experienced/Master)
- Sort by date or score
- Settings screen with difficulty, keep-awake toggle
- Settings affect app behavior
- Consistent theming across all screens
</success_criteria>

<output>
After completion, create `.planning/phases/04-ui-user-experience/04-04-SUMMARY.md`
</output>
