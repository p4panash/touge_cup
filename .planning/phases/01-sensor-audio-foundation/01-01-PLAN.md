---
phase: 01-sensor-audio-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app.json
  - package.json
  - tsconfig.json
  - src/sensors/types.ts
  - src/sensors/DeviceMotionManager.ts
  - src/sensors/filters/LowPassFilter.ts
  - src/stores/useSensorStore.ts
  - App.tsx
autonomous: true

must_haves:
  truths:
    - "DeviceMotion sensor data streams at 50Hz when app is running"
    - "Acceleration values are gravity-compensated (isolated from phone tilt)"
    - "Sensor data is filtered to remove high-frequency vibration noise"
  artifacts:
    - path: "src/sensors/types.ts"
      provides: "Type definitions for sensor data"
      contains: "SensorData"
    - path: "src/sensors/DeviceMotionManager.ts"
      provides: "DeviceMotion subscription management"
      exports: ["DeviceMotionManager"]
    - path: "src/sensors/filters/LowPassFilter.ts"
      provides: "IIR low-pass filter for noise removal"
      exports: ["LowPassFilter"]
    - path: "src/stores/useSensorStore.ts"
      provides: "Zustand store for high-frequency sensor state"
      exports: ["useSensorStore"]
  key_links:
    - from: "src/sensors/DeviceMotionManager.ts"
      to: "expo-sensors DeviceMotion"
      via: "DeviceMotion.addListener subscription"
      pattern: "DeviceMotion\\.addListener"
    - from: "src/sensors/DeviceMotionManager.ts"
      to: "src/sensors/filters/LowPassFilter.ts"
      via: "filter.apply() on each sensor event"
      pattern: "lowPass\\.apply"
---

<objective>
Initialize the Expo project and implement the sensor data pipeline for real-time motion capture.

Purpose: Establish the foundation for the driving coach app with proper sensor data acquisition at 50Hz, filtered for noise reduction. This is the first link in the sensor-to-audio chain.

Output: Working Expo development build with DeviceMotion streaming filtered, gravity-compensated acceleration data to a Zustand store.
</objective>

<execution_context>
@/Users/papanash/.claude/get-shit-done/workflows/execute-plan.md
@/Users/papanash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-sensor-audio-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Expo project with required dependencies</name>
  <files>
    app.json
    package.json
    tsconfig.json
    App.tsx
  </files>
  <action>
Create a new Expo project using the blank TypeScript template:

```bash
npx create-expo-app@latest touge-cup --template blank-typescript
```

If project already exists at root, skip creation and work with existing files.

Configure app.json:
- Set name to "Water Cup Coach"
- Set slug to "water-cup-coach"
- Add Android permission for HIGH_SAMPLING_RATE_SENSORS (required for 50Hz on Android 12+):
  ```json
  "android": {
    "permissions": ["android.permission.HIGH_SAMPLING_RATE_SENSORS"]
  }
  ```

Install required dependencies:
```bash
npx expo install expo-sensors expo-asset
npm install zustand react-native-audio-api
```

Note: react-native-audio-api requires a development build (not Expo Go). Run `npx expo prebuild` after all native modules are added.

Configure tsconfig.json for path aliases:
- Add `"baseUrl": "."` and `"paths": { "@/*": ["src/*"] }` to compilerOptions

Update App.tsx to use a simple placeholder that imports from src/ to verify path aliases work.

Do NOT run prebuild yet - wait until Plan 03 when all native modules are installed.
  </action>
  <verify>
- `npm run lint` or `npx tsc --noEmit` passes without errors
- package.json includes expo-sensors, expo-asset, zustand, react-native-audio-api
- app.json has HIGH_SAMPLING_RATE_SENSORS permission
  </verify>
  <done>
Project initialized with all Phase 1 dependencies, TypeScript configured with path aliases, Android sensor permission declared.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement sensor pipeline (DeviceMotion + LowPassFilter + Store)</name>
  <files>
    src/sensors/types.ts
    src/sensors/DeviceMotionManager.ts
    src/sensors/filters/LowPassFilter.ts
    src/stores/useSensorStore.ts
  </files>
  <action>
Create src/sensors/types.ts with type definitions:
```typescript
export interface Vector3 {
  x: number;
  y: number;
  z: number;
}

export interface SensorData {
  acceleration: Vector3;      // Gravity-compensated, in m/s^2
  rotationRate: Vector3;      // Angular velocity in rad/s
  timestamp: number;          // Seconds since epoch
}

export interface FilteredSensorData extends SensorData {
  filteredAcceleration: Vector3;  // After low-pass filter
}
```

Create src/sensors/filters/LowPassFilter.ts:
- Implement single-pole IIR low-pass filter
- Constructor takes cutoffHz (default 2Hz) and sampleHz (default 50Hz)
- Calculate alpha using: `dt / (rc + dt)` where `rc = 1/(2*pi*fc)`
- apply() method takes Vector3, returns filtered Vector3
- reset() method clears filter state
- See 01-RESEARCH.md "Low-Pass IIR Filter Implementation" for exact implementation

Create src/sensors/DeviceMotionManager.ts:
- Class that wraps DeviceMotion subscription lifecycle
- Constructor takes callback: (data: FilteredSensorData) => void
- start() method:
  - Call DeviceMotion.setUpdateInterval(20) for 50Hz
  - Subscribe via DeviceMotion.addListener
  - Apply LowPassFilter to acceleration data
  - Invoke callback with FilteredSensorData
- stop() method removes subscription
- Use DeviceMotion from expo-sensors (not Accelerometer - DeviceMotion provides gravity-compensated acceleration)

Create src/stores/useSensorStore.ts:
- Zustand store for sensor state
- State: { latestData: FilteredSensorData | null, isActive: boolean }
- Actions: setLatestData, setActive
- Keep store minimal - high-frequency updates (50Hz) require lean state

Wire it together:
- DeviceMotionManager should update the store on each sensor event
- This will be consumed by the smoothness engine in Plan 02
  </action>
  <verify>
- `npx tsc --noEmit` passes
- All files exist at specified paths
- LowPassFilter has apply() and reset() methods
- DeviceMotionManager has start() and stop() methods
- useSensorStore exports a Zustand hook
  </verify>
  <done>
Sensor pipeline complete: DeviceMotion streams 50Hz gravity-compensated data through low-pass filter to Zustand store. Ready for smoothness engine integration.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. TypeScript compilation: `npx tsc --noEmit` succeeds
2. All source files exist in src/sensors/ and src/stores/
3. Dependencies installed: check package.json for expo-sensors, zustand
4. Android permission present in app.json

Note: Full sensor testing requires a physical device with development build. That verification happens in Plan 03 after prebuild.
</verification>

<success_criteria>
- Expo project initialized with TypeScript and path aliases
- All Phase 1 dependencies in package.json
- DeviceMotionManager subscribes to sensor events at 50Hz
- LowPassFilter removes high-frequency noise (1-2Hz cutoff)
- Zustand store receives filtered sensor data
- Code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-sensor-audio-foundation/01-01-SUMMARY.md`
</output>
