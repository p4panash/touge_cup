---
phase: 02-background-execution-permissions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - app.json
  - src/drive/types.ts
  - src/drive/constants.ts
autonomous: true

must_haves:
  truths:
    - "GPS-related packages are installed and available for import"
    - "app.json has iOS UIBackgroundModes for location and audio"
    - "app.json has Android permissions for background location"
    - "Drive detection types define all state machine states"
  artifacts:
    - path: "src/drive/types.ts"
      provides: "DriveState, DriveEvent, LocationData types"
      exports: ["DriveState", "DriveEvent", "LocationData"]
    - path: "src/drive/constants.ts"
      provides: "Speed thresholds, timing constants"
      exports: ["SPEED_THRESHOLD_MS", "START_DURATION_MS", "STOP_DURATION_MS"]
  key_links:
    - from: "app.json"
      to: "expo-location"
      via: "plugins array"
      pattern: "expo-location"
---

<objective>
Install background execution dependencies and create drive detection type foundation.

Purpose: Establish the package infrastructure and type definitions needed for GPS-based drive detection. This plan creates no runtime behavior, only infrastructure that subsequent plans build upon.

Output: Installed packages (expo-location, expo-task-manager, expo-battery, expo-intent-launcher), configured app.json with background modes and permissions, and TypeScript types/constants for drive detection.
</objective>

<execution_context>
@/Users/papanash/.claude/get-shit-done/workflows/execute-plan.md
@/Users/papanash/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-background-execution-permissions/02-CONTEXT.md
@.planning/phases/02-background-execution-permissions/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install packages and configure app.json</name>
  <files>package.json, app.json</files>
  <action>
1. Install required packages:
   ```
   npx expo install expo-location expo-task-manager expo-battery expo-intent-launcher
   ```

2. Update app.json with background modes and permissions. Add to the existing config:

   In `expo.ios.infoPlist`:
   ```json
   "UIBackgroundModes": ["location", "audio"],
   "NSLocationAlwaysAndWhenInUseUsageDescription": "Water Cup Coach needs continuous location access to detect when you're driving and provide real-time feedback.",
   "NSLocationWhenInUseUsageDescription": "Water Cup Coach uses your location to detect driving speed."
   ```

   In `expo.android.permissions` (add to existing):
   ```json
   "ACCESS_FINE_LOCATION",
   "ACCESS_COARSE_LOCATION",
   "ACCESS_BACKGROUND_LOCATION",
   "FOREGROUND_SERVICE",
   "FOREGROUND_SERVICE_LOCATION"
   ```

   In `expo.plugins` array (add expo-location plugin):
   ```json
   [
     "expo-location",
     {
       "locationAlwaysAndWhenInUsePermission": "Water Cup Coach needs continuous location access to detect when you're driving and provide real-time feedback.",
       "isIosBackgroundLocationEnabled": true,
       "isAndroidBackgroundLocationEnabled": true,
       "isAndroidForegroundServiceEnabled": true
     }
   ]
   ```

Note: Keep existing plugins (expo-asset). Keep existing android.permissions (HIGH_SAMPLING_RATE_SENSORS).
  </action>
  <verify>
Run `npx expo doctor` to verify config is valid. Check package.json includes all 4 new dependencies.
  </verify>
  <done>
Packages installed, app.json has UIBackgroundModes ["location", "audio"], Android has all 5 location permissions, expo-location plugin configured with background options.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create drive detection types and constants</name>
  <files>src/drive/types.ts, src/drive/constants.ts</files>
  <action>
1. Create `src/drive/types.ts` with:

```typescript
/**
 * Drive detection state machine states
 *
 * State transitions:
 * - idle -> detecting: speed >= threshold
 * - detecting -> idle: speed drops below threshold before 5s
 * - detecting -> driving: speed sustained for 5s
 * - driving -> stopping: speed near zero
 * - stopping -> driving: speed resumes before 120s
 * - stopping -> idle: stationary for 120s
 * - manual_driving: user override, only manual stop works
 */
export type DriveState =
  | { type: 'idle' }
  | { type: 'detecting'; speedAboveThresholdSince: number }
  | { type: 'driving'; startTime: number }
  | { type: 'stopping'; stationarySince: number; driveStartTime: number }
  | { type: 'manual_driving'; startTime: number };

/**
 * Location data from GPS
 * Simplified from expo-location LocationObject
 */
export interface LocationData {
  /** Latitude in degrees */
  latitude: number;
  /** Longitude in degrees */
  longitude: number;
  /** Speed in m/s (may be null if unavailable) */
  speed: number | null;
  /** Timestamp when location was recorded */
  timestamp: number;
  /** Horizontal accuracy in meters */
  accuracy: number | null;
}

/**
 * Drive events for logging (Phase 3 will persist these)
 */
export type DriveEventType = 'drive_start' | 'drive_end' | 'gps_lost' | 'gps_resumed';

export interface DriveEvent {
  type: DriveEventType;
  timestamp: number;
  location: LocationData | null;
  /** For drive_end: was it auto-stop or manual */
  manual?: boolean;
}

/**
 * Permission status for location
 */
export type LocationPermissionStatus =
  | 'undetermined'
  | 'foreground_only'
  | 'background_granted'
  | 'denied';
```

2. Create `src/drive/constants.ts` with:

```typescript
/**
 * Drive detection constants
 * @see 02-CONTEXT.md for locked decisions
 */

/** Speed threshold for drive detection: 15 km/h in m/s */
export const SPEED_THRESHOLD_MS = 4.17;

/** Duration above threshold to start drive: 5 seconds */
export const START_DURATION_MS = 5000;

/** Duration stationary to stop drive: 120 seconds */
export const STOP_DURATION_MS = 120000;

/** Speed below which counts as "stationary": ~3.6 km/h in m/s */
export const STATIONARY_THRESHOLD_MS = 1.0;

/** Location update interval: 1 second */
export const LOCATION_UPDATE_INTERVAL_MS = 1000;

/** GPS breadcrumb interval for route tracking: 5 seconds */
export const BREADCRUMB_INTERVAL_MS = 5000;

/** Background task name for expo-task-manager */
export const LOCATION_TASK_NAME = 'background-location-task';

/** Foreground service notification config */
export const FOREGROUND_SERVICE_CONFIG = {
  notificationTitle: 'Water Cup Coach',
  notificationBody: 'Monitoring your driving...',
  notificationColor: '#3B82F6',
} as const;
```

Note: Use `as const` for the foreground service config to ensure type safety.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`. Import types in a test file to verify exports work.
  </verify>
  <done>
src/drive/types.ts exports DriveState, LocationData, DriveEvent, LocationPermissionStatus. src/drive/constants.ts exports all threshold values and LOCATION_TASK_NAME.
  </done>
</task>

</tasks>

<verification>
1. `npm ls expo-location expo-task-manager expo-battery expo-intent-launcher` shows all packages installed
2. `npx expo doctor` shows no configuration errors
3. `npx tsc --noEmit` compiles without errors
4. app.json contains UIBackgroundModes with ["location", "audio"]
</verification>

<success_criteria>
- All 4 new packages in package.json dependencies
- app.json properly configured for iOS and Android background location
- TypeScript types compile and export correctly
- No runtime code yet - this is infrastructure only
</success_criteria>

<output>
After completion, create `.planning/phases/02-background-execution-permissions/02-01-SUMMARY.md`
</output>
